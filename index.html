<!DOCTYPE html>
<html>
<head>
    <title>Pharmacokinetic Modeling and Visualization Tool</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <h1>Pharmacokinetic Modeling and Visualization Tool</h1>
    <h2 style="text-align: left;">Background</h2>
    <p style="padding-bottom: 10px;"> Fill in some background as to what this thing does.
        It hits some fancy diff-eqs, then it rams some numbers through some packages. Then
        it spits out numbers and a wonderful graph as desired.
    </p>
    <hr class="solid">
    <h2 style="padding-top: 10px;">Pharmacokinetic Data Modeling Calculator</h2>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/8.1.0/math.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/numeric/1.2.6/numeric.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.min.js"></script>
    <script src="https://unpkg.com/optimization-js@latest/dist/optimization.js"></script>

    <div style="display: flex">
        <div>
            <form id=inputform>
                <table cellspacing="10" cellpadding="10" id="input_table">
                    <tr id="row1">
                        <td>
                            <label for="comps">Number of Compartments</label>
                        </td>
                        <td>
                            <select id="comps" onchange="gen_k_fields()">
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                            </select>
                        </td>
                    </tr>
                    <tr id="row2">
                        <td>
                            <label for="kvalues">Compartment Info</label>
                        </td>
                        <td>
                            <table id="kval_table">
                            </table>
                        </td>
                    </tr>
                    <tr id="row3">
                        <td>
                            <label for="timerange">Time Range and Units</label>
                        </td>
                        <td>
                            <input type="number" id="timerange" value="250" style="width: 70px">
                            <input id="time-units" value="minutes" style="width: 70px">
                        </td>
                    </tr>
                    <tr id="row4">
                        <td>
                            <label for="nsteps">Number of steps</label>
                        </td>
                        <td>
                            <input type="number" id="nsteps" value="100000" style="width: 70px">
                        </td>
                    </tr>
                    <tr id="row5">
                        <td>
                            <label for="massconc">Mass or Concentration</label>
                        </td>
                        <td>
                            <select id="massconc" onchange="gen_conc_field()">
                                <option value="Mass">Mass</option>
                                <option value="Concentration">Concentration</option>
                            </select>
                        </td>
                    </tr>
                    <tr id="buttonrow">
                        <td>
                            <button type="button" onclick="ode()">Calculate & Graph</button>
                        </td>
                        <td>
                            <button type="button" onclick="download()">Download</button>
                            <button type="button" onclick="test()">Test</button>
                        </td>
                    </tr>
                </table>
            </form>
        </div>
        <div style="width: 725px; height: 500px; padding-left: 15px;">
            <canvas  id="my_graph"></canvas>
            <div style="align-items: center;">
                <p id="output"></p>
            </div>
        </div>
    </div>
    <div>
        <hr class="solid">
        <h2 style="padding-top: 10px;">k-value Calculator</h2>
    </div>

<script>
    function gen_k_fields() {
        var num_fields = parseInt(document.getElementById("comps").value);
        var table = document.getElementById("kval_table");
        // reset innerHTML
        table.innerHTML = "<tr>\n<th>Number</th>\n<th>Name</th>\n<th>Initial value</th>\n<th>k-value</th></tr>";
        for (i = 0; i < num_fields; i++) {
            var row = document.createElement("tr");
            var cell_label = document.createElement("td");
            var label = document.createElement("label");
            label.innerHTML = (i + 1).toString();
            cell_label.appendChild(label);

            var cell_name = document.createElement("td");
            var name_field = document.createElement("input");
            name_field.setAttribute("id", "name" + (i + 1))
            name_field.setAttribute("style", "width: 100px");
            cell_name.appendChild(name_field);

            var cell_ival = document.createElement("td");
            var ival_field = document.createElement("input");
            ival_field.setAttribute("id", "i_val" + (i + 1))
            ival_field.setAttribute("style", "width: 70px")
            ival_field.setAttribute("type", "number");
            cell_ival.appendChild(ival_field);

            var cell_k = document.createElement("td");
            var k_field = document.createElement("input");
            k_field.setAttribute("id", "k_val" + (i + 1))
            k_field.setAttribute("style", "width: 70px")
            k_field.setAttribute("type", "number");
            cell_k.appendChild(k_field);
            
            row.appendChild(cell_label);
            row.appendChild(cell_name);
            row.appendChild(cell_ival);
            row.appendChild(cell_k);

            table.appendChild(row);
        }
        if (document.getElementById("massconc").value == "Concentration") {
                document.getElementById("input_table").deleteRow(5)
                gen_conc_field();
        }
    }

    function gen_conc_field() {
        if (document.getElementById("massconc").value == "Concentration") {
            var row = document.getElementById("input_table").insertRow(5);

            var cell_label = document.createElement("td");
            var label = document.createElement("label");
            label.innerHTML = "Animal Model Constant";
            cell_label.appendChild(label);
            row.appendChild(cell_label);

            var cell_input = document.createElement("td");
            var input_field = document.createElement("input");
            input_field.setAttribute("id", "a_const");
            input_field.setAttribute("style", "padding-right: 50px;");
            input_field.setAttribute("style", "width: 70px");
            cell_input.appendChild(input_field);

            var form = document.createElement("form");
            var num_fields = parseInt(document.getElementById("comps").value);
            for (i = 0; i < num_fields; i++) {
                if (i == 0) {
                    var brk1 = document.createElement("br");
                    cell_input.appendChild(brk1);
                }
                var option = document.createElement("input");
                option.setAttribute("type", "checkbox")
                option.setAttribute("class", "checks");
                option.setAttribute("value", (i + 1).toString());
                option.setAttribute("style", "padding: 5px;");
                form.appendChild(option);

                var opt_lbl = document.createElement("label");
                opt_lbl.setAttribute("style", "font-size: 12px; padding: 5px;");
                opt_lbl.innerHTML = "Compartment " + (i + 1);
                form.appendChild(opt_lbl);
                if (num_fields > 3 && i == 2) {
                    var brk2 = document.createElement("br");
                    form.appendChild(brk2);
                }
            }
            cell_input.appendChild(form);
            row.appendChild(cell_input);
        } else {
            document.getElementById("input_table").deleteRow(5)
        }
    }

</script>

<script>
    /* From Ricky Reusser (2015) ode-rk4. Integrates a system of ODEs using the
     * Fourth Order Runge-Kutta (RK-4) Method.
     */
    var Integrator = function Integrator( y0, deriv, t, dt ) {
        // Bind variables to this:
        this.deriv = deriv;
        this.y = y0;
        this.n = this.y.length;
        this.dt = dt;
        this.t = t;
        // Create array to store all the y-values for graphing:
        this.y_collection = [];

        // Create a scratch array into which we compute the derivative:
        this._ctor = this.y.constructor;

        this._w = new this._ctor(this.n);
        this._k1 = new this._ctor(this.n);
        this._k2 = new this._ctor(this.n);
        this._k3 = new this._ctor(this.n);
        this._k4 = new this._ctor(this.n)
    }

    Integrator.prototype.step = function() {

        this.deriv(this._k1, this.y, this.t);

        for (var i=0; i<this.n; i++) {
            this._w[i] = this.y[i] + this._k1[i] * this.dt * 0.5;
        }

        this.deriv(this._k2, this._w, this.t + this.dt * 0.5);

        for (var i=0; i<this.n; i++) {
            this._w[i] = this.y[i] + this._k2[i] * this.dt * 0.5;
        }

        this.deriv(this._k3, this._w, this.t + this.dt * 0.5);

        for (var i=0; i<this.n; i++) {
            this._w[i] = this.y[i] + this._k3[i] * this.dt;
        }

        this.deriv(this._k4, this._w, this.t + this.dt);

        var dto6 = this.dt / 6.0;
        for (var i=0; i<this.n; i++) {
            this.y[i] += dto6 * (this._k1[i] + 2*this._k2[i] + 2*this._k3[i] + this._k4[i]);
        }
        this.t += this.dt;
        this.y_collection.push([...this.y]);
        return this;
    }

    Integrator.prototype.steps = function( n ) {
        for (var step=0; step<n; step++) {
            this.step();
        }
        return this;
    }
</script>

<script>
    var integrator;

    function parse_k_table() {
        var k_array = [];
        var init_array = [];
        var num_fields = parseInt(document.getElementById("comps").value);

        for (i = 0; i < num_fields; i++) {
            k_array.push(parseFloat(document.getElementById("k_val" + (i + 1)).value));
            init_array.push(parseFloat(document.getElementById("i_val" + (i + 1)).value));
        }
        return [k_array, init_array];
    }

    function parse_time_nsteps() {
        var time = parseFloat(document.getElementById("timerange").value);
        var t_units = document.getElementById("time-units").value
        var nsteps = parseInt(document.getElementById("nsteps").value);
        return [time, nsteps, t_units];
    }

    function parse_checks(num_fields) {
        var checks = document.getElementsByClassName("checks");
        console.log(checks);
        var select_indexes = [];

        for (i = 0; i < num_fields; i++) {
            if (checks[i].checked) {
                select_indexes.push(parseInt(checks[i].value));
            }
        }
        return select_indexes;
    }

    function process_out(array, time, t_units) {
        var out_str = "<b><u>Final Results at " + time + " " + t_units + "</u></b><br>";
        for (i = 0; i < array.length; i++) {
            out_str += ("Compartment " + (i + 1) + ": " + array[i].toPrecision(3) + "<br>");
        }
        return out_str;
    }
    
    var colors = ["#70B9B5", "#EB8138", "#6E6CC0", "#E64445", "#8E99A0", "#38A9C7"]
    var chart_data = {
        datasets: [
            {
                id: "comp_1_data",
                label: "Compartment 1",
                borderColor: colors[0],
                showLine: true,
                data: [],
                pointRadius: 0,
            },
            {
                id: "comp_2_data",
                label: "Compartment 2",
                borderColor: colors[1],
                showLine: true,
                data: [],
                pointRadius: 0,
            },
            {
                id: "comp_3_data",
                label: "Compartment 3",
                borderColor: colors[2],
                showLine: true,
                data: [],
                pointRadius: 0,
            },
            {
                id: "comp_4_data",
                label: "Compartment 4",
                borderColor: colors[3],
                showLine: true,
                data: [],
                pointRadius: 0,
            },
            {
                id: "comp_5_data",
                label: "Compartment 5",
                borderColor: colors[4],
                showLine: true,
                data: [],
                pointRadius: 0,
            },
            {
                id: "comp_6_data",
                label: "Compartment 6",
                borderColor: colors[5],
                showLine: true,
                data: [],
                pointRadius: 0,
            },
        ]

    };

    function shorten_out(y) {
        const len = y.length;
        var x = numeric.linspace(0, parseFloat(document.getElementById("timerange").value), 
            parseInt(document.getElementById("nsteps").value));
        var shortened_x = [];
        var shortened_y = [];
        for (i = 0; i < len; i++) {
            if (i % 100 == 0) {
                shortened_x.push(x[i]);
                shortened_y.push(y[i]);
            }
        }
        return [shortened_x, shortened_y];
    }

    function graph() {
        var shortened_arr = shorten_out(integrator.y_collection);
        var x_coords = shortened_arr[0];
        var y_coords = shortened_arr[1];
        console.log(x_coords);
        console.log(y_coords);
        var num_datasets = y_coords[0].length; // All the same length

        // Empty everything out first
        for (i = 0; i < 6; i++) {
            window.chart.data.datasets[i].data = [];
        }

        // Populate datasets that exist
        for (i = 0; i < num_datasets; i++) {
            window.chart.data.datasets[i].data = x_coords.map((x_data, j) => ({
                x: +x_data.toPrecision(3), y: +y_coords[j][i].toPrecision(3)}));
        }

        console.log(window.chart.data.datasets);
        window.chart.update();

    }

    function ode() {
        var ktable = parse_k_table();
        var time_nsteps = parse_time_nsteps();
        var num_fields = parseInt(document.getElementById("comps").value);

        var y0 = ktable[1];
        var k = ktable[0];
        var time = time_nsteps[0];
        var nsteps = time_nsteps[1];
        var dt = time/nsteps;

        var a_const = 1;
        var select_indexes = [];

        if (document.getElementById("massconc").value == "Concentration") {
            a_const = math.evaluate(document.getElementById("a_const").value);
            select_indexes = parse_checks(num_fields);
        }
        console.log(select_indexes);

        var dydt = function(dydt, y, t) {
            for (i = 0; i < num_fields; i++) {
                if (i == 0 && select_indexes.includes(i + 1)) {
                    dydt[0] = k[0] * -y[0] / (a_const);
                } else if (select_indexes.includes(i + 1)) {
                    dydt[i] = k[i] * -y[i] + k[i - 1] * y[i - 1] / (a_const); 
                } else if (i == 0) {
                    dydt[0] = k[0] * -y[0];
                } else {
                    dydt[i] = k[i] * -y[i] + k[i - 1] * y[i - 1];
                }
            }
        }

        integrator = new Integrator(y0, dydt, 0, dt);
        integrator.steps(nsteps);
        document.getElementById("output").innerHTML = process_out(integrator.y, time_nsteps[0], time_nsteps[2]);
        console.log(integrator);
        console.log(integrator.y);
        console.log(integrator.y_collection);

        window.chart.options.scales.xAxes[0].scaleLabel.labelString = "Time " + "(" + document.getElementById("time-units").value + ")";
        window.chart.options.scales.yAxes[0].scaleLabel.labelString = document.getElementById("massconc").value;
        graph();
        window.chart.update();

    }
    
    window.onload = function() {
        var ctx = document.getElementById("my_graph").getContext("2d");
        window.chart = new Chart(ctx, {
            type: "scatter",
            data: chart_data,
            options: {
                responsive: true,
                title: {
                    display: false,
                    text: "Compartment Model Graph"
                },
                animation: {
                    duration: 0 // general animation time
                },
                hover: {
                    animationDuration: 0 // duration of animations when hovering an item
                },
                responsiveAnimationDuration: 0, // animation duration after a resize
                legend: {
                    display: true,
                    labels: {
                        filter: function (item, chart) {
                            return chart_data.datasets[item.datasetIndex].data.length; // if there is no data length -> 0
                        }
                    },
                },
                scales: {
                    xAxes: [{
                        position: "bottom",
                        scaleLabel: {
                            display: true,
                            labelString: "Time " + "(" + document.getElementById("time-units").value + ")",
                        },
                        gridLines: {
                            drawOnChartArea: false,
                        }
                    }],
                    yAxes: [{
                        display: true,
                        position: "left",
                        scaleLabel: {
                            display: true,
                            labelString: document.getElementById("massconc").value,
                        },
                        gridLines: {
                            drawOnChartArea: false,
                        },
                    }]
                }, 
                elements: {
                    line: {
                        fill: false,
                    },
                    gridLines: {
                        drawOnChartArea: false,
                    },
                }

            },
        })
        gen_k_fields(); // Default value is 1
    };
    


</script>

<script>
    function test() {
        
        var y0 = [4000, 0, 0];
        var t0 = 0;
        var t_end = 400;
        var n = 100000;
        var dt = t_end/n;
        
        var k = [200, 0.6, 0.06]
        //var k = [200, 0.60891022, 0.06007484];

        var dydt = function(dydt, y, t) {
            dydt[0] = k[0] * -y[0];
            dydt[1] = k[1] * -y[1] + k[0] * y[0];
            dydt[2] = k[2] * -y[2] + k[1] * y[1] / (.142*.3);  
        }

        var integrator = new Integrator(y0, dydt, t0, dt);
        integrator.steps(n);
        console.log(integrator);
        console.log(integrator.y);
        console.log(integrator.y_collection);
    }
</script>

</body>
    
</html>