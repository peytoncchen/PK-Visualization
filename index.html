<!DOCTYPE html>
<html>
<head>
    <title>Pharmacokinetic Modeling and Visualization Tool</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="utf-8">
    <link rel="stylesheet" href="style.css">
    <script type="text/javascript">
        // set the pyodide files URL (packages.json, pyodide.asm.data etc)
        window.languagePluginUrl = 'https://cdn.jsdelivr.net/pyodide/v0.16.1/full/';
    </script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.16.1/full/pyodide.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/8.1.0/math.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/numeric/1.2.6/numeric.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.min.js"></script>
</head>
<body>
    <h1>Pharmacokinetic Modeling and Visualization Tool</h1>
    <h2 style="text-align: left;">Background</h2>
    <p style="padding-bottom: 10px;"> Fill in some background as to what this thing does.
        It hits some fancy diff-eqs, then it rams some numbers through some packages. Then
        it spits out numbers and a wonderful graph as desired. Part 2 uses Pyodide which allows
        us to run scipy.optimize.brute find low SSEs and proceed with a gradient descent - go WASM!
    </p>
    <hr class="solid">
    <h2 style="padding-top: 10px;">Pharmacokinetic Data Modeling Calculator and Visualizer</h2>

    <div style="display: flex">
        <div>
            <form id="inputform">
                <table cellspacing="10" cellpadding="10" id="input_table">
                    <tr>
                        <td>
                            <label for="comps">Number of Compartments</label>
                        </td>
                        <td>
                            <select id="comps" onchange="gen_k_fields('comps', 'kval_table', 'massconc')">
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <label for="kvalues">Compartment Info</label>
                        </td>
                        <td>
                            <table id="kval_table">
                            </table>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <label for="timerange">Time Range and Units</label>
                        </td>
                        <td>
                            <input type="number" id="timerange" value="250" onchange="reset_output()" style="width: 70px">
                            <input id="time-units" value="minutes" onchange="reset_output()" style="width: 70px">
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <label for="nsteps">Number of steps</label>
                        </td>
                        <td>
                            <input type="number" id="nsteps" value="100000" onchange="reset_output()" style="width: 70px">
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <label for="massconc">Mass or Concentration</label>
                        </td>
                        <td>
                            <select id="massconc" onchange="gen_conc_field('massconc', 'input_table', 5, 'comps')">
                                <option value="Mass">Mass</option>
                                <option value="Concentration">Concentration</option>
                            </select>
                        </td>
                    </tr>
                    <tr id="button_row">
                        <td>
                            <button type="button" id="calcgraph" onclick="ode()">Calculate & Graph</button>
                        </td>
                        <td id="dwnld_box">
                            <button type="button" id="dwnld" onclick="download()" disabled>Download</button>
                            <label for="filename" id="filename-label" style="font-size: 13px; opacity: 0.4;">Filename:</label>
                            <input id="filename" style="width: 100px" disabled>
                            <div id="select_dwnld"></div>
                        </td>
                    </tr>
                </table>
            </form>
        </div>
        <div style="padding-left: 5px;">
            <canvas style="width: 600px; height: 375px;"id="my_graph"></canvas>
            <div style="align-items: center;">
                <p id="output" style="padding-left: 15px;"></p>
            </div>
        </div>
    </div>
    <div>
        <hr class="solid">
        <h2 style="padding-top: 10px;">k-value Calculator</h2>
        <div style="margin: auto;">
            <form id="inputform2">
                <table style="float: left;" cellspacing="10" cellpadding="10" id="input_table2">
                    <tr>
                        <td>
                            <label for="file_csv">Choose CSV file to upload</label>
                        </td>
                        <td>
                            <input type="file" id="file_csv" accept=".csv,.txt">
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <label for="comps2">Number of Compartments</label>
                        </td>
                        <td>
                            <select id="comps2" onchange="gen_k_fields('comps2', 'kval_table2', 'massconc2')">
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <label for="massconc2">Mass or Concentration</label>
                        </td>
                        <td>
                            <select id="massconc2" onchange="gen_conc_field('massconc2', 'input_table2', 3, 'comps2')">
                                <option value="Mass">Mass</option>
                                <option value="Concentration">Concentration</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <label>CSV data represents</label>
                        </td>
                        <td id="calck_cell">
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <button type="button" id="calck" onclick="calculate_k()" disabled>Calculate k-values</button>
                        </td>
                    </tr>
                </table>
                <table style="float: left" cellspacing="10" cellpadding="10" id="kval_table2">
                </table>
            </form>
            <p id="finalresult" style="padding-left: 20px;"></p>
        </div>
    </div>

<script>

    /* On change of number of compartments, this function will create the needed input components depending on
     * whether the change is detected in the part 1 calculator or part 2 calculator.
     */
    function gen_k_fields(comps, k_table, conc) {
        var num_fields = parseInt(document.getElementById(comps).value);
        var table = document.getElementById(k_table);

        // reset innerHTML
        if (k_table == "kval_table") {
            table.innerHTML = "<tr>\n<th>Number</th>\n<th>Name (optional)</th>\n<th>Initial value</th>\n<th>k-value</th></tr>";
        } else {
            table.innerHTML = `<tr>\n<th>Compartment</th>\n<th>Low Bound</th>\n<th>High Bound</th>\n<th>Initial value
                </th><th>Constrain</th><th>k-value</th></tr>`;
        }
        
        for (var i = 0; i < num_fields; i++) {
            var row = document.createElement("tr");

            var cell_label = document.createElement("td");
            var label = document.createElement("label");
            label.innerHTML = (i + 1).toString();
            cell_label.appendChild(label);
            row.appendChild(cell_label);

            if (k_table == "kval_table") {
                var cell_name = document.createElement("td");
                var name_field = document.createElement("input");
                name_field.setAttribute("id", "name" + (i + 1));
                name_field.setAttribute("style", "width: 100px");
                name_field.setAttribute("onchange", "reset_output()");
                cell_name.appendChild(name_field);
                row.appendChild(cell_name);

                var cell_ival = document.createElement("td");
                var ival_field = document.createElement("input");
                ival_field.setAttribute("id", "i_val" + (i + 1));
                ival_field.setAttribute("style", "width: 70px");
                ival_field.setAttribute("type", "number");
                ival_field.setAttribute("onchange", "reset_output()");
                cell_ival.appendChild(ival_field);
                row.appendChild(cell_ival);

                var cell_k = document.createElement("td");
                var k_field = document.createElement("input");
                k_field.setAttribute("id", "k_val" + (i + 1));
                k_field.setAttribute("style", "width: 70px");
                k_field.setAttribute("onchange", "reset_output()");
                k_field.setAttribute("type", "number");
                cell_k.appendChild(k_field);
                row.appendChild(cell_k);
            } else {
                var cell_l_bou = document.createElement("td");
                var l_bou_field = document.createElement("input");
                l_bou_field.setAttribute("id", "l_bou" + (i + 1));
                l_bou_field.setAttribute("style", "width: 70px");
                l_bou_field.setAttribute("type", "number");
                cell_l_bou.appendChild(l_bou_field);
                row.appendChild(cell_l_bou);

                var cell_h_bou = document.createElement("td");
                var h_bou_field = document.createElement("input");
                h_bou_field.setAttribute("id", "h_bou" + (i + 1));
                h_bou_field.setAttribute("style", "width: 70px");
                h_bou_field.setAttribute("type", "number");
                cell_h_bou.appendChild(h_bou_field);
                row.appendChild(cell_h_bou);

                var cell_ival2 = document.createElement("td");
                var ival2 = document.createElement("input");
                ival2.setAttribute("id", "i_val" + (i + 1) + "2");
                ival2.setAttribute("style", "width: 70px");
                ival2.setAttribute("type", "number");
                cell_ival2.appendChild(ival2);
                row.appendChild(cell_ival2);

                var cell_const = document.createElement("td");
                var option = document.createElement("input");
                option.setAttribute("type", "checkbox");
                option.setAttribute("class", "constrain");
                option.setAttribute("value", (i + 1).toString());
                option.setAttribute("style", "padding: 5px;");
                option.setAttribute("onchange", "bou_off()");
                cell_const.appendChild(option);
                row.appendChild(cell_const);

                var cell_k_try = document.createElement("td");
                var k_try = document.createElement("input");
                k_try.setAttribute("id", "k_try" + (i + 1));
                k_try.setAttribute("style", "width: 70px");
                k_try.setAttribute("type", "number");
                k_try.setAttribute("disabled", true);
                cell_k_try.appendChild(k_try);
                row.appendChild(cell_k_try);
            }

            table.appendChild(row);
        }
        if (document.getElementById(conc).value == "Concentration") {
            var row = k_table == "kval_table" ? 5 : 3;
            var inp_table = k_table == "kval_table" ? "input_table" : "input_table2";
            document.getElementById(inp_table).deleteRow(row)
            gen_conc_field(conc, inp_table, row, comps);
        }
        if (k_table == "kval_table") {
            reset_output();
        } else {
            gen_sel_data(num_fields);
        }
    }

    // For part 2, generates radio buttons for user to select which compartment their CSV data represents.
    function gen_sel_data(num_fields) {
        var cell = document.getElementById("calck_cell");
        cell.innerHTML = "";
        for (var i = 0; i < num_fields; i++) {
            var radio_but = document.createElement("input");
            radio_but.setAttribute("type", "radio");
            radio_but.setAttribute("name", "select")
            radio_but.setAttribute("value", (i + 1).toString());
            if (i == 0) {
                radio_but.setAttribute("checked", true)
            }
            cell.appendChild(radio_but);

            var label = document.createElement("label");
            label.setAttribute("style", "font-size: 13px; padding: 5px");
            label.innerHTML = "Compartment " + (i + 1);
            cell.appendChild(label);
            if (num_fields > 3 && i == 2) {
                var brk2 = document.createElement("br");
                cell.appendChild(brk2);
            }
        }
    }

    /* Creates a group of check boxes for a variety of different functions including animal model constant selection
     * for both parts and download compartment selection for part 1.
     */
    function create_checks(div, class_nm, tb_row, cell_input, comps) {
        var num_fields = parseInt(document.getElementById(comps).value);
        for (var i = 0; i < num_fields; i++) {
            var option = document.createElement("input");
            option.setAttribute("type", "checkbox")
            option.setAttribute("class", class_nm);
            option.setAttribute("value", (i + 1).toString());
            div.appendChild(option);

            var opt_lbl = document.createElement("label");
            opt_lbl.setAttribute("style", "font-size: 13px; padding: 5px;");

            opt_lbl.innerHTML = "Compartment " + (i + 1);
            div.appendChild(opt_lbl);
            if (num_fields > 3 && i == 2) {
                var brk2 = document.createElement("br");
                div.appendChild(brk2);
            }
        }
        cell_input.appendChild(div);
    }

    /* Creates concentration input field for both a concentration constant and compartment selection to modify with
     * the concentration constant.
     */
    function gen_conc_field(option, inp_table, row, comps) {
        if (document.getElementById(option).value == "Concentration") {
            var row = document.getElementById(inp_table).insertRow(row);

            var cell_label = document.createElement("td");
            var label = document.createElement("label");
            label.innerHTML = "Animal Model Constant";
            cell_label.appendChild(label);
            row.appendChild(cell_label);

            var cell_input = document.createElement("td");
            var input_field = document.createElement("input");
            input_field.setAttribute("id", "a_const");
            input_field.setAttribute("style", "width: 70px");
            cell_input.appendChild(input_field);

            var div = document.createElement("div");
            var chk_class = inp_table == "input_table" ? "checks" : "checks2"
            create_checks(div, chk_class, row, cell_input, comps);
            row.appendChild(cell_input);
        } else {
            document.getElementById(inp_table).deleteRow(row)
        }
        if (inp_table == "input_table") {
            reset_output();
        }
    }

    /* Depending on whether constrain box is checked, toggles whether bounds or k-value inputs are open or 
     * disabled.
     */
    function bou_off() {
        var num_fields = parseInt(document.getElementById("comps2").value);
        var indexes = parse_checks("constrain", num_fields)
        for (var i = 0; i < num_fields; i++) {
            if (indexes.includes(i + 1)) {
                var lelem = document.getElementById("l_bou" + (i + 1));
                var helem = document.getElementById("h_bou" + (i + 1));
                document.getElementById("k_try" + (i + 1)).disabled = false;
                lelem.disabled = true;
                lelem.value = "";
                helem.disabled = true;
                helem.value = "";
            } else {
                document.getElementById("h_bou" + (i + 1)).disabled = false;
                document.getElementById("l_bou" + (i + 1)).disabled = false;
                var k_try = document.getElementById("k_try" + (i + 1));
                k_try.disabled = true;
                k_try.value = "";
            }
        }
        
    }

    /* For part 1 resets output by clearing graph datasets and resetting all generated output and enabling/disabling
     * necessary buttons and input fields.
     */
    function reset_output() {
        document.getElementById("dwnld").disabled = true;
        document.getElementById("select_dwnld").innerHTML = "";
        document.getElementById("filename").disabled = true;
        document.getElementById("filename-label").style.opacity = 0.4;
        document.getElementById("filename").value = "";
        document.getElementById("calcgraph").disabled = false;

        document.getElementById("output").innerHTML = "";
        for (var i = 0; i < 6; i++) {
            window.chart.data.datasets[i].data = [];
        }
        window.chart.update();
    }

</script>

<script>
    /* Adapted from Ricky Reusser (2015) ode-rk4. Integrates a system of ODEs using the
     * Fourth Order Runge-Kutta (RK-4) Method.
     */
    var Integrator = function Integrator(y0, deriv, t, dt) {
        // Bind variables to this:
        this.deriv = deriv;
        this.y = y0;
        this.n = this.y.length;
        this.dt = dt;
        this.t = t;
        // Create array to store all the y-values for graphing:
        this.y_collection = [];

        // Create a scratch array into which we compute the derivative:
        this._ctor = this.y.constructor;

        this._w = new this._ctor(this.n);
        this._k1 = new this._ctor(this.n);
        this._k2 = new this._ctor(this.n);
        this._k3 = new this._ctor(this.n);
        this._k4 = new this._ctor(this.n)
    }

    Integrator.prototype.step = function() {
        this.deriv(this._k1, this.y, this.t);
        for (var i = 0; i < this.n; i++) {
            this._w[i] = this.y[i] + this._k1[i] * this.dt * 0.5;
        }
        this.deriv(this._k2, this._w, this.t + this.dt * 0.5);
        for (var i = 0; i < this.n; i++) {
            this._w[i] = this.y[i] + this._k2[i] * this.dt * 0.5;
        }
        this.deriv(this._k3, this._w, this.t + this.dt * 0.5);
        for (var i = 0; i < this.n; i++) {
            this._w[i] = this.y[i] + this._k3[i] * this.dt;
        }
        this.deriv(this._k4, this._w, this.t + this.dt);
        var dto6 = this.dt / 6.0;
        for (var i = 0; i < this.n; i++) {
            this.y[i] += dto6 * (this._k1[i] + 2*this._k2[i] + 2*this._k3[i] + this._k4[i]);
        }
        this.t += this.dt;
        this.y_collection.push([...this.y]);
        return this;
    }

    Integrator.prototype.steps = function( n ) {
        for (var step = 0; step < n; step++) {
            this.step();
        }
        return this;
    }
</script>

<script>
    /* --------------------- Part 1 PK Data Modeling Global Variables --------------------- */
    var integrator;
    var full_dataset;

    /* --------------------------------- Part 1 functions --------------------------------- */

    // Parses and returns an array representation of the k-value table labeled "Compartment Info".
    function parse_k_table() {
        var k_array = [];
        var init_array = [];
        var num_fields = parseInt(document.getElementById("comps").value);

        for (var i = 0; i < num_fields; i++) {
            k_array.push(parseFloat(document.getElementById("k_val" + (i + 1)).value));
            init_array.push(parseFloat(document.getElementById("i_val" + (i + 1)).value));
        }
        return [k_array, init_array];
    }

    // Parses and returns time range, the units of the time range and the number of steps.
    function parse_time_nsteps() {
        var time = parseFloat(document.getElementById("timerange").value);
        var t_units = document.getElementById("time-units").value
        var nsteps = parseInt(document.getElementById("nsteps").value);
        return [time, nsteps, t_units];
    }

    // Parses and returns array selected indexes given a class of check boxes.
    function parse_checks(class_nm, num_fields) {
        var checks = document.getElementsByClassName(class_nm);
        var select_indexes = [];

        for (var i = 0; i < num_fields; i++) {
            if (checks[i].checked) {
                select_indexes.push(parseInt(checks[i].value));
            }
        }
        return select_indexes;
    }

    // Given array result and time range and units information, parses and returns an HTML string.
    function process_out(array, time, t_units) {
        var out_str = "<b><u>Final Results at " + time + " " + t_units + "</u></b><br>";
        for (var i = 0; i < array.length; i++) {
            out_str += ("Compartment " + (i + 1) + ": " + (isNaN(array[i]) ? "error": array[i].toPrecision(4))  
                + "<br>");
        }
        return out_str;
    }
    
    // Global variables for the chart in part 1
    var colors = ["#70B9B5", "#EB8138", "#6E6CC0", "#E64445", "#8E99A0", "#38A9C7"] // These colors are the bomb
    var chart_data = {
        datasets: [
            {
                id: "comp_1_data",
                label: "Compartment 1",
                borderColor: colors[0],
                showLine: true,
                data: [],
                pointRadius: 0,
            },
            {
                id: "comp_2_data",
                label: "Compartment 2",
                borderColor: colors[1],
                showLine: true,
                data: [],
                pointRadius: 0,
            },
            {
                id: "comp_3_data",
                label: "Compartment 3",
                borderColor: colors[2],
                showLine: true,
                data: [],
                pointRadius: 0,
            },
            {
                id: "comp_4_data",
                label: "Compartment 4",
                borderColor: colors[3],
                showLine: true,
                data: [],
                pointRadius: 0,
            },
            {
                id: "comp_5_data",
                label: "Compartment 5",
                borderColor: colors[4],
                showLine: true,
                data: [],
                pointRadius: 0,
            },
            {
                id: "comp_6_data",
                label: "Compartment 6",
                borderColor: colors[5],
                showLine: true,
                data: [],
                pointRadius: 0,
            },
        ]

    };

    /* Takes in y (and makes x by itself with linspace from numeric) and produces a shortened version of the
     * resulting arrays for easier load on the export tool. It will take the number of entries and divide by 100.
     */
    function shorten_out(y) {
        const len = y.length;
        var x = numeric.linspace(0, parseFloat(document.getElementById("timerange").value), 
            parseInt(document.getElementById("nsteps").value));
        var shortened_x = [];
        var shortened_y = [];
        for (var i = 0; i < len; i++) {
            if (i % 100 == 0) {
                shortened_x.push(x[i]);
                shortened_y.push(y[i]);
            }
        }
        return [shortened_x, shortened_y];
    }

    // Graphs data processed and set to global variables onto the chart for part 1.
    function graph() {
        var shortened_arr = shorten_out(integrator.y_collection);
        var x_coords = shortened_arr[0];
        var y_coords = shortened_arr[1];
        if (x_coords.length != y_coords.length) {
            alert("Array generation error. Please refresh page.");
        }
        var num_datasets = y_coords[0].length; // All the same length

        // Empty everything out first
        for (var i = 0; i < 6; i++) {
            window.chart.data.datasets[i].data = [];
        }

        // Populate datasets that exist
        for (var i = 0; i < num_datasets; i++) {
            window.chart.data.datasets[i].data = x_coords.map((x_data, j) => ({
                x: +x_data.toPrecision(4), y: +y_coords[j][i].toPrecision(5)}));
        }

        window.chart.update();
        return [x_coords, y_coords];

    }

    /* Calls all the parsing functions and integrates the set of differential equations. Will also call the graph function
     * to graph everything and set the output to the appropriate values.
     */
    function ode() {
        var ktable = parse_k_table();
        var time_nsteps = parse_time_nsteps();
        var num_fields = parseInt(document.getElementById("comps").value);

        var y0 = ktable[1];
        var k = ktable[0];
        var time = time_nsteps[0];
        var nsteps = time_nsteps[1];
        var dt = time/nsteps;

        var a_const = 1;
        var select_indexes = [];

        if (document.getElementById("massconc").value == "Concentration") {
            a_const = math.evaluate(document.getElementById("a_const").value);
            select_indexes = parse_checks("checks", num_fields);
        }

        var dydt = function(dydt, y, t) {
            for (var i = 0; i < num_fields; i++) {
                if (i == 0 && select_indexes.includes(i + 1)) {
                    dydt[0] = k[0] * -y[0] / (a_const);
                } else if (select_indexes.includes(i + 1)) {
                    dydt[i] = k[i] * -y[i] + k[i - 1] * y[i - 1] / (a_const); 
                } else if (i == 0) {
                    dydt[0] = k[0] * -y[0];
                } else {
                    dydt[i] = k[i] * -y[i] + k[i - 1] * y[i - 1];
                }
            }
        }

        integrator = new Integrator(y0, dydt, 0, dt);
        integrator.steps(nsteps);
        document.getElementById("output").innerHTML = process_out(integrator.y, time_nsteps[0], time_nsteps[2]);

        window.chart.options.scales.xAxes[0].scaleLabel.labelString = "Time " + "(" + document.getElementById("time-units").value 
            + ")";
        window.chart.options.scales.yAxes[0].scaleLabel.labelString = document.getElementById("massconc").value;
        full_dataset = graph();
        window.chart.update();
        var select_dwnld = document.getElementById("select_dwnld");
        create_checks(select_dwnld, "dwnld_check", document.getElementById("button_row"),
            document.getElementById("dwnld_box"), "comps");
        document.getElementById("dwnld").disabled = false;
        document.getElementById("filename").disabled = false;
        document.getElementById("filename-label").style.opacity = 1;
        document.getElementById("calcgraph").disabled = true;
    }

    // Gets the names of the compartments if they exist and returns them in an array to be used for headers in the exported CSV.
    function get_headers(select_indexes) {
        var header_arr = [];
        header_arr.push("Time " + "(" + document.getElementById("time-units").value + ")");
        for (var i = 0; i < select_indexes.length; i++) {
            var name_id = "name" + select_indexes[i];
            header_arr.push(document.getElementById(name_id).value + " (Comp " + select_indexes[i] + ")");
        }
        return header_arr;
    }

    // Processes and parses full_dataset modified by integrator in ode() to be exported to CSV.
    function process_array_dwnld(select_indexes) {
        var x_coords = full_dataset[0];
        var y_coords = full_dataset[1];
        var result = [];
        result.push(get_headers(select_indexes));

        for (var i = 0; i < x_coords.length; i++) {
            result.push([(+x_coords[i].toPrecision(4)).toLocaleString("fullwide", {useGrouping: false})]);
        }
        for (var i = 0; i < y_coords.length; i++) {
            for (var j = 0; j < select_indexes.length; j++) {
                result[i + 1].push((+y_coords[i][select_indexes[j] - 1].toPrecision(5)).toLocaleString("fullwide",
                    {useGrouping: false}));
            }
        }
        return result;
    }

    // Export an array to CSV format to the user's download location.
    function export_to_csv(filename, rows) {
        var processRow = function(row) {
            var finalVal = '';
            for (var j = 0; j < row.length; j++) {
                var innerValue = row[j] === null ? '' : row[j].toString();
                var result = innerValue.replace(/"/g, '""');
                if (result.search(/("|,|\n)/g) >= 0) {
                    result = '"' + result + '"';
                }
                if (j > 0) {
                    finalVal += ',';
                }
                finalVal += result;
            }
            return finalVal + '\n';
        };

        var csvFile = '';
        for (var i = 0; i < rows.length; i++) {
            csvFile += processRow(rows[i]);
        }

        var blob = new Blob([csvFile], {type: "text/csv;charset=utf-8;"});
        if (navigator.msSaveBlob) { // IE 10+
            navigator.msSaveBlob(blob, filename);
        } else {
            var link = document.createElement("a");
            if (link.download !== undefined) { // feature detection
                // Browsers that support HTML5 download attribute
                var url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", filename);
                link.style.visibility = "hidden";
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }
    }

    // Download helper that is called during ode() routine.
    function download() {
        var select_indexes = parse_checks("dwnld_check", parseInt(document.getElementById("comps").value));
        var rows = process_array_dwnld(select_indexes);
        var filename = document.getElementById("filename").value ? document.getElementById("filename").value : "export";
        export_to_csv(filename + ".csv", rows);
    }

    /*  -- Part 2 k-val Calc Global Variables (More global vars because pyodide needs to access them) -- */
    var in_csv_data;
    var represents;
    var k_table2;
    var dydt2;
    var num_fields2;
    var a_const2;
    var select_indexes2;

    /* --------------------------------- Part 2 functions --------------------------------- */

    // Given text format of inputted CSV file processes it and returns an array.
    function parse_csv(allText) {
        var allTextLines = allText.split(/\r\n|\n/);
        var headers = allTextLines[0].split(',');
        var lines = [];

        for (var i = 1; i < allTextLines.length; i++) {
            var data = allTextLines[i].split(',');
            if (data.length == headers.length) {
                var inner_arr = [];
                for (var j = 0; j < headers.length; j++) {
                    var point = parseFloat(data[j]);
                    if (!isNaN(point)) { // not adding NaN lines
                        inner_arr.push(point);
                    }
                }
                lines.push(inner_arr);
            }
        }
        return lines;
    }

    // Read csv helper that will return a Promise once the csv file is read.
    function read_helper(reader, file_upload) {
        return new Promise((resolve, reject) => {
            reader.onload = function (e) {
            let csvdata = e.target.result;
            resolve(parse_csv(csvdata));
            }
            reader.readAsText(file_upload.files[0]);
        })
    }

    // Async function that will read the csv, process it and return the parsed data in the form of a js array.
    async function read_csv() {
        var file_upload = document.getElementById("file_csv");
        if (!file_upload) {
            alert("No CSV file uploaded.")
            return [];
        }
        var reader = new FileReader();
        var parsed_data = await read_helper(reader, file_upload);
        return parsed_data;
    }

    // Parses the second k_table from part 2 and returns an array representation of the user inputted data.
    function parse_k_table2() {
        var num_fields = parseInt(document.getElementById("comps2").value);
        var bounds = [];
        var init_array = [];
        var k_try = [];

        for (var i = 0; i < num_fields; i++) {
            var i_bound = [];
            if (parseFloat(document.getElementById("l_bou" + (i + 1)).value)) { // only push if not NaN
                i_bound.push(parseFloat(document.getElementById("l_bou" + (i + 1)).value));
                i_bound.push(parseFloat(document.getElementById("h_bou" + (i + 1)).value));
            }
            bounds.push(i_bound);
            init_array.push(parseFloat(document.getElementById("i_val" + (i + 1) + "2").value));
            if (parseFloat(document.getElementById("k_try" + (i + 1)).value)) { // only push if not NaN
                k_try.push([parseFloat(document.getElementById("k_try" + (i + 1)).value), (i + 1)]);   
            }
        }
        return [bounds, init_array, k_try];
    }

    // Parses a group of radio buttons grouped by name and returns the selected index.
    function parse_radio(name, num_fields) {
        var radio = document.getElementsByName(name);
        var select_index;

        for (var i = 0; i < num_fields; i++) {
            if (radio[i].checked) {
                select_index = parseInt(radio[i].value);
                break;
            }
        }
        return select_index;
    }

    // Processes the final k-value result and outputs an HTML string to be displayed on screen.
    function process_final(array) {
        var out_str = "<b><u>Final k-value results</u></b><br>";
        for (var i = 0; i < array.length; i++) {
            out_str += ("Compartment " + (i + 1) + " k-value: " + (isNaN(array[i]) ? "error": array[i].toPrecision(4))  
                + "<br>");
        }
        return out_str;
    }

    /* Calls all the parsing functions and with all the appropriate data generated, calls pyodide.runPython which will run
     * a python script to brute force determine the k-values. Outputs any errors through alerts and successful results on screen.
     * This function can take 2-5 minutes to run depending on inputs. Also note that there is heavy RAM usage.
     */
    async function calculate_k() {
        k_table2 = parse_k_table2();
        num_fields2 = parseInt(document.getElementById("comps2").value);
        represents = parse_radio("select", num_fields2);

        a_const2 = 1;
        select_indexes2 = [];
        if (document.getElementById("massconc2").value == "Concentration") {
            a_const2 = math.evaluate(document.getElementById("a_const").value);
            select_indexes2 = parse_checks("checks2", num_fields2);
        }
        try {
            in_csv_data = await read_csv();
        } catch (err) {
            alert("CSV data was unable to be read.")
            return;
        }
        dydt2 = function(dydt2, y, t) {
            let k = pyodide.globals.k
            for (var i = 0; i < num_fields2; i++) {
                if (i == 0 && select_indexes2.includes(i + 1)) {
                    dydt2[0] = k[0] * -y[0] / (a_const2);
                } else if (select_indexes2.includes(i + 1)) {
                    dydt2[i] = k[i] * -y[i] + k[i - 1] * y[i - 1] / (a_const2); 
                } else if (i == 0) {
                    dydt2[0] = k[0] * -y[0];
                } else {
                    dydt2[i] = k[i] * -y[i] + k[i - 1] * y[i - 1];
                }
            }
        }

        document.getElementById("finalresult").innerHTML = "Loading... can take 2-5 minutes."
        
        /* For comments of the python code as well as a configurable Jupyter Notebook check out the calc_k.py and 
         * pk_example.ipynb in the "PK-Py folder" on my Github.
         */

        try {
            pyodide.runPython(`
                import js

                in_csv_data = js.in_csv_data
                js_table = js.k_table2
                dydt2 = js.dydt2
                represents = js.represents
                
                def copy_array(array):
                    copy = [[],[],[]]
                    copy[0] = [[lst[0], lst[1]] if lst else [] for lst in array[0]]
                    copy[1] = [num for num in array[1]]
                    copy[2] = [num for num in array[2]]
                    return copy
                
                k_table2 = copy_array(js_table)

                def arr_to_dic(arr):
                    result = {}
                    for i in range(len(arr)):
                        if arr[i][0] not in result and len(arr[i]) != 1:
                            result[arr[i][0]] = [arr[i][1]]
                        elif len(arr[i]) != 1:
                            result[arr[i][0]].append(arr[i][1])
                    return result
                
                dic = arr_to_dic(in_csv_data)
                print(dic)

                def SSE(fit_dic, actual_dic):
                    SSE = 0
                    for time in fit_dic:
                        fit_conc = fit_dic[time]
                        for actual_value in actual_dic[time]:
                            diff = actual_value - fit_conc
                            SSE += math.sqrt(diff**2)
                    return SSE

                total_time = max(list(dic))
                timepoints = 100

                def construct_time(dic):
                    time_range = np.linspace(0,total_time,total_time*timepoints+1)
                    time_measured = list(dic)

                    time_range_list = list(time_range)
                    time_index = []
                    for timepoint in time_measured:
                        for index in range(len(time_range_list)):
                            if time_range_list[index] >= timepoint:
                                time_index.append(index)
                                break
                    return time_measured, time_index

                def make_fit_dic(solve, actual_dic):
                    returnDic = {}
                    timemeasured,timeindex = construct_time(actual_dic)
                    need_solve = []
                    for i in range(len(solve)):
                        need_solve.append(solve[i][represents - 1]) # Only data for the compartment CSV data represents
                    non_normal_conc = [] 
                    for index in timeindex:
                        non_normal_conc.append(need_solve[index])
                    max_conc = max(non_normal_conc)
                    normal_conc = [x/max_conc for x in non_normal_conc] # Normalize
                    for i in range(len(timeindex)):
                        returnDic[timemeasured[i]] = normal_conc[i] # Populate the return dictionary
                    return returnDic

                y0 = k_table2[1][:]
                k = []
                dt = total_time/(total_time*timepoints+1)

                def SSEfromK(ks):
                    global k 
                    k = ks
                    if k_table2[2]:
                        for i in range(len(k_table2[2])):
                            entry = k_table2[2][i]
                            k[entry[1] - 1] = entry[0]
                    
                    integrator = js.Integrator.new(y0, dydt2, 0, dt)
                    integrator.steps(total_time*timepoints+1)
                    full_dataset2 = integrator.y_collection

                    fit = make_fit_dic(full_dataset2, dic)
                    return SSE(fit, dic)
                
                def process_bounds(array):
                    result = []
                    bounds = array[0]
                    k_try = array[2]
                    index_k_try = 0
                    for i in range(len(bounds)):
                        if bounds[i]:
                            result.append((bounds[i][0], bounds[i][1]))
                        else:
                            result.append((k_try[index_k_try][0], k_try[index_k_try][0]))
                            index_k_try += 1
                    return tuple(result)
                
                bounds_tup = tuple(process_bounds(k_table2))

                final_result = list(brute(SSEfromK, bounds_tup, Ns=2))
                print(final_result)
        `)
        } catch (err) {
            document.getElementById("finalresult").innerHTML = "There was an error in calculating k-values.";
            alert("There was an error in calculating k-values. Consider refreshing the page and trying again.");
            return;
        }
        document.getElementById("finalresult").innerHTML = process_final(pyodide.globals.final_result);
    }
    
    /* All the things that needs to happen onload including generating appropriate input fields, starting pyodide and 
     * importing all the packages, as well as initializing and configuring the graph for part 2.
     */

    window.onload = function() {
        var ctx = document.getElementById("my_graph").getContext("2d");
        window.chart = new Chart(ctx, {
            type: "scatter",
            data: chart_data,
            options: {
                responsive: true,
                title: {
                    display: false,
                    text: "Compartment Model Graph"
                },
                animation: {
                    duration: 0 // general animation time
                },
                hover: {
                    animationDuration: 0 // duration of animations when hovering an item
                },
                responsiveAnimationDuration: 0, // animation duration after a resize
                legend: {
                    display: true,
                    labels: {
                        filter: function (item, chart) {
                            return chart_data.datasets[item.datasetIndex].data.length; // if there is no data, length -> 0
                        }
                    },
                },
                scales: {
                    xAxes: [{
                        position: "bottom",
                        scaleLabel: {
                            display: true,
                            labelString: "Time " + "(" + document.getElementById("time-units").value + ")",
                        },
                        gridLines: {
                            drawOnChartArea: false,
                        }
                    }],
                    yAxes: [{
                        display: true,
                        position: "left",
                        scaleLabel: {
                            display: true,
                            labelString: document.getElementById("massconc").value,
                        },
                        gridLines: {
                            drawOnChartArea: false,
                        },
                    }]
                }, 
                elements: {
                    line: {
                        fill: false,
                    },
                    gridLines: {
                        drawOnChartArea: false,
                    },
                }

            },
        })
        gen_k_fields("comps", "kval_table", "massconc"); // Default value is 1
        gen_k_fields("comps2", "kval_table2", "massconc2") // Default value also 1
        languagePluginLoader.then( function () {
            console.log(pyodide.runPython(`
                import sys
                import math
                sys.version
            `));
            pyodide.loadPackage(['numpy', 'scipy']).then(() => {
                pyodide.runPython('import numpy as np');
                pyodide.runPython('from scipy.optimize import brute');
                document.getElementById("calck").disabled = false; // Button is disabled until everything has loaded.
            });
            
        });
    };
</script>
</body>    
</html>