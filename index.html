<!DOCTYPE html>
<html>
<head>
    <title>Pharmacokinetic Modeling and Visualization Tool</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
</head>
<body onload="gen_k_fields()">
    <h1>Pharmacokinetic Modeling and Visualization Tool</h1>
    <h2 style="text-align: left;">Background</h2>
    <p style="padding-bottom: 10px;"> Fill in some background as to what this thing does.
        It hits some fancy diff-eqs, then it rams some numbers through some packages. Then
        it spits out numbers and a wonderful graph as desired.
    </p>
    <hr class="solid">
    <h2 style="padding-top: 10px;">Pharmacokinetic Data Modeling Calculator</h2>
    
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/8.1.0/math.js"></script> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/numeric/1.2.6/numeric.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.min.js"></script>
    <script src="https://unpkg.com/optimization-js@latest/dist/optimization.js"></script>

    <div style="display: flex">
        <div>
            <form id=inputform>
                <table cellspacing="10" cellpadding="10" id="input_table">
                    <tr id="row1">
                        <td>
                            <label for="comps">Number of Compartments</label>
                        </td>
                        <td>
                            <select id="comps" onchange="gen_k_fields()">
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                            </select>
                        </td>
                    </tr>
                    <tr id="row2">
                        <td>
                            <label for="kvalues">Compartment Info</label>
                        </td>
                        <td>
                            <table id="kval_table">
                            </table>
                        </td>
                    </tr>
                    <tr id="row3">
                        <td>
                            <label for="timerange">Time Range (minutes)</label>
                        </td>
                        <td>
                            <input type="number" id="timerange" value="250" style="width: 70px">
                        </td>
                    </tr>
                    <tr id="row4">
                        <td>
                            <label for="nsteps">Number of steps</label>
                        </td>
                        <td>
                            <input type="number" id="nsteps" value="100000" style="width: 70px">
                        </td>
                    </tr>
                    <tr id="row5">
                        <td>
                            <label for="massconc">Mass or Concentration</label>
                        </td>
                        <td>
                            <select id="massconc" onchange="gen_conc_field()">
                                <option value="mass">Mass</option>
                                <option value="conc">Concentration</option>
                            </select>
                        </td>
                    </tr>
                    <tr id="buttonrow">
                        <td>
                            <button type="button" onclick="ode_and_graph()">Calc + Graph</button>
                        </td>
                        <td>
                            <button type="button" onclick="test()">Test</button>
                        </td>
                    </tr>
                </table>
            </form>
        </div>
        <div style="width: 1000px; height: 500px">
            <canvas id="my_graph"></canvas>
        </div>
    </div>

<script>
    function gen_k_fields() {
        var num_fields = parseInt(document.getElementById("comps").value);
        var table = document.getElementById("kval_table");
        // reset innerHTML
        table.innerHTML = "<tr>\n<th>Number</th>\n<th>Name</th>\n<th>k-value</th>\n<th>Initial value</th></tr>";
        for (i = 0; i < num_fields; i++) {
            var row = document.createElement("tr");
            var cell_label = document.createElement("td");
            var label = document.createElement("label");
            label.innerHTML = (i + 1).toString();
            cell_label.appendChild(label);

            var cell_name = document.createElement("td");
            var name_field = document.createElement("input");
            name_field.setAttribute("id", "name" + (i + 1))
            name_field.setAttribute("style", "width: 100px");
            cell_name.appendChild(name_field);

            var cell_k = document.createElement("td");
            var k_field = document.createElement("input");
            k_field.setAttribute("id", "k_val" + (i + 1))
            k_field.setAttribute("style", "width: 70px")
            k_field.setAttribute("type", "number");
            cell_k.appendChild(k_field);

            var cell_ival = document.createElement("td");
            var ival_field = document.createElement("input");
            ival_field.setAttribute("id", "i_val" + (i + 1))
            ival_field.setAttribute("style", "width: 70px")
            ival_field.setAttribute("type", "number");
            cell_ival.appendChild(ival_field);
            
            row.appendChild(cell_label);
            row.appendChild(cell_name);
            row.appendChild(cell_k);
            row.appendChild(cell_ival);

            table.appendChild(row);
        }
    }
</script>

<script>
    function gen_conc_field() {
        if (document.getElementById("massconc").value == "conc") {
            var row = document.getElementById("input_table").insertRow(5);

            var cell_label = document.createElement("td");
            var label = document.createElement("label");
            label.innerHTML = "Animal Model Constant";
            cell_label.appendChild(label);
            row.appendChild(cell_label);

            var cell_input = document.createElement("td");
            var input_field = document.createElement("input");
            input_field.setAttribute("id", "a_const");
            input_field.setAttribute("style", "width: 70px")
            input_field.setAttribute("type", "number");
            cell_input.appendChild(input_field);
            row.appendChild(cell_input);
        } else {
            document.getElementById("input_table").deleteRow(5)
        }
    }
</script>

<script>
    /* From Ricky Reusser (2015) ode-rk4. Integrates a system of ODEs using the
     * Fourth Order Runge-Kutta (RK-4) Method.
     */
    var Integrator = function Integrator( y0, deriv, t, dt ) {
        // Bind variables to this:
        this.deriv = deriv;
        this.y = y0;
        this.n = this.y.length;
        this.dt = dt;
        this.t = t;
        // Create array to store all the y-values for graphing:
        this.y_collection = [];

        // Create a scratch array into which we compute the derivative:
        this._ctor = this.y.constructor;

        this._w = new this._ctor(this.n);
        this._k1 = new this._ctor(this.n);
        this._k2 = new this._ctor(this.n);
        this._k3 = new this._ctor(this.n);
        this._k4 = new this._ctor(this.n)
    }

    Integrator.prototype.step = function() {

        this.deriv(this._k1, this.y, this.t);

        for (var i=0; i<this.n; i++) {
            this._w[i] = this.y[i] + this._k1[i] * this.dt * 0.5;
        }

        this.deriv(this._k2, this._w, this.t + this.dt * 0.5);

        for (var i=0; i<this.n; i++) {
            this._w[i] = this.y[i] + this._k2[i] * this.dt * 0.5;
        }

        this.deriv(this._k3, this._w, this.t + this.dt * 0.5);

        for (var i=0; i<this.n; i++) {
            this._w[i] = this.y[i] + this._k3[i] * this.dt;
        }

        this.deriv(this._k4, this._w, this.t + this.dt);

        var dto6 = this.dt / 6.0;
        for (var i=0; i<this.n; i++) {
            this.y[i] += dto6 * (this._k1[i] + 2*this._k2[i] + 2*this._k3[i] + this._k4[i]);
        }
        this.t += this.dt;
        this.y_collection.push([...this.y]);
        return this;
    }

    Integrator.prototype.steps = function( n ) {
        for (var step=0; step<n; step++) {
            this.step();
        }
        return this;
    }
</script>

<script>
    function parse_k_table() {
        var k_array = [];
        var init_array = [];
        var num_fields = parseInt(document.getElementById("comps").value);

        for (i = 0; i < num_fields; i++) {
            k_array.push(parseFloat(document.getElementById("k_val" + (i + 1)).value));
            init_array.push(parseFloat(document.getElementById("i_val" + (i + 1)).value));
        }
        return [k_array, init_array];
    }

    function parse_time_nsteps() {
        var time = parseFloat(document.getElementById("timerange").value);
        var nsteps = parseInt(document.getElementById("nsteps").value);
        return [time, nsteps];
    }

    function ode_and_graph() {
        var ktable = parse_k_table();
        var time_nsteps = parse_time_nsteps();
        var num_fields = parseInt(document.getElementById("comps").value);

        var y0 = ktable[1];
        var k = ktable[0];
        var time = time_nsteps[0];
        var nsteps = time_nsteps[1];
        var dt = time/nsteps;

        var dydt = function(dydt, y, t) {
            for (i = 0; i < num_fields; i++) {
                if (i == 0) {
                    dydt[0] = k[0] * -y[0];
                } else if (i + 1 == num_fields) {
                    dydt[i] = k[i] * -y[i] + k[i - 1] * y[i - 1] / (.142*.3); // Add animal constant support
                } else {
                    dydt[i] = k[i] * -y[i] + k[i - 1] * y[i - 1];
                }
            }
        }

        var integrator = new Integrator(y0, dydt, 0, dt);
        integrator.steps(nsteps);
        console.log(integrator);
        console.log(integrator.y);
        console.log(integrator.y_collection);

    }
</script>

<script>
    function test() {
        
        var y0 = [4000, 0, 0];
        var t0 = 0;
        var t_end = 400;
        var n = 100000;
        var dt = t_end/n;
        
        var k = [200, 0.60891022, 0.06007484];

        var dydt = function(dydt, y, t) {
            dydt[0] = k[0] * -y[0];
            dydt[1] = k[1] * -y[1] + k[0] * y[0];
            dydt[2] = k[2] * -y[2] + k[1] * y[1] / (.142*.3);  
        }

        var integrator = new Integrator(y0, dydt, t0, dt);
        integrator.steps(n);
        console.log(integrator);
        console.log(integrator.y);
        console.log(integrator.y_collection);
    }
</script>

</body>
    
</html>